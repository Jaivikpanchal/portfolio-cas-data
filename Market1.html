<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Portfolio ¬∑ Live NAV Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0d0f14;--surface:#13161e;--surface2:#1a1e28;--border:#252933;
    --accent:#00e5a0;--accent2:#3d8bff;--warn:#ff6b6b;--gold:#f5c842;--text:#e8eaf0;--muted:#6b7385}
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh}
  body::before{content:'';position:fixed;top:-200px;left:-200px;width:700px;height:700px;
    background:radial-gradient(circle,rgba(0,229,160,0.07) 0%,transparent 70%);pointer-events:none;z-index:0}
  body::after{content:'';position:fixed;bottom:-200px;right:-200px;width:600px;height:600px;
    background:radial-gradient(circle,rgba(61,139,255,0.05) 0%,transparent 70%);pointer-events:none;z-index:0}
  .wrap{max-width:980px;margin:0 auto;padding:32px 18px;position:relative;z-index:1}

  #loader{position:fixed;inset:0;background:var(--bg);z-index:999;display:flex;flex-direction:column;
    align-items:center;justify-content:center;gap:16px;transition:opacity 0.4s}
  #loader.hide{opacity:0;pointer-events:none}
  .spinner{width:44px;height:44px;border:3px solid var(--border);border-top-color:var(--accent);
    border-radius:50%;animation:spin 0.8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  #loader p{font-family:'DM Mono',monospace;font-size:0.8rem;color:var(--muted)}

  .tape-wrap{width:100%;background:var(--surface);border-bottom:1px solid var(--border);
    overflow:hidden;padding:10px 0;position:relative}
  .tape-wrap::before,.tape-wrap::after{content:'';position:absolute;top:0;width:80px;height:100%;z-index:2;pointer-events:none}
  .tape-wrap::before{left:0;background:linear-gradient(90deg,var(--surface),transparent)}
  .tape-wrap::after{right:0;background:linear-gradient(-90deg,var(--surface),transparent)}
  .tape-track{display:flex;gap:0;animation:tape 40s linear infinite;width:max-content}
  .tape-wrap:hover .tape-track{animation-play-state:paused}
  @keyframes tape{from{transform:translateX(0)}to{transform:translateX(-50%)}}
  .tape-item{display:inline-flex;align-items:center;gap:10px;padding:0 28px;border-right:1px solid var(--border);white-space:nowrap}
  .tape-item .ti-name{font-size:0.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.06em}
  .tape-item .ti-price{font-family:'DM Mono',monospace;font-size:0.82rem;font-weight:500}
  .tape-item .ti-chg{font-family:'DM Mono',monospace;font-size:0.72rem;padding:2px 7px;border-radius:4px}
  .ti-chg.up{background:rgba(0,229,160,0.12);color:var(--accent)}
  .ti-chg.dn{background:rgba(255,107,107,0.1);color:var(--warn)}
  .ti-chg.flat{background:rgba(107,115,133,0.15);color:var(--muted)}

  .market-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;margin-bottom:8px}
  .mcard{background:var(--surface);border:1px solid var(--border);border-radius:12px;
    padding:16px 18px;transition:border-color 0.2s,transform 0.15s;position:relative;overflow:hidden}
  .mcard:hover{border-color:rgba(0,229,160,0.25);transform:translateY(-2px)}
  .mcard .mc-label{font-size:0.62rem;text-transform:uppercase;letter-spacing:0.08em;color:var(--muted);margin-bottom:8px}
  .mcard .mc-price{font-family:'DM Mono',monospace;font-size:1.1rem;font-weight:600;margin-bottom:5px}
  .mcard .mc-chg{font-family:'DM Mono',monospace;font-size:0.75rem;display:inline-block;padding:3px 9px;border-radius:5px}
  .mcard .mc-chg.up{background:rgba(0,229,160,0.1);color:var(--accent)}
  .mcard .mc-chg.dn{background:rgba(255,107,107,0.1);color:var(--warn)}
  .mcard .mc-chg.flat{color:var(--muted)}
  .mcard .mc-sub{font-size:0.63rem;color:var(--muted);margin-top:5px}
  .mcard-skeleton{opacity:0.35}
  .pulse-dot{width:6px;height:6px;background:var(--accent);border-radius:50%;
    display:inline-block;margin-right:4px;animation:pulse 2s infinite}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.2}}

  .hdr{margin-bottom:20px;margin-top:8px}
  .hdr-top{display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px;margin-bottom:16px}
  .hdr h1{font-family:'DM Serif Display',serif;font-size:2rem;line-height:1.15}
  .hdr h1 span{color:var(--accent)}
  .hdr-meta{font-size:0.78rem;color:var(--muted);margin-top:4px}
  .hdr-meta b{color:var(--accent);font-weight:500}
  .badge-auto{display:inline-flex;align-items:center;gap:6px;background:rgba(0,229,160,0.07);
    border:1px solid rgba(0,229,160,0.18);padding:6px 14px;border-radius:999px;
    font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--accent)}
  .dot{width:7px;height:7px;border-radius:50%;background:var(--accent);animation:pulse 2s infinite}

  .goal-bar{background:var(--surface);border:1px solid var(--border);border-radius:12px;
    padding:14px 20px;display:flex;gap:24px;flex-wrap:wrap;align-items:center}
  .gi .gl{font-size:0.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.07em}
  .gi .gv{font-family:'DM Mono',monospace;font-size:0.95rem;margin-top:3px;font-weight:600}
  .col-green{color:var(--accent)}.col-blue{color:var(--accent2)}.col-gold{color:var(--gold)}
  .col-red{color:var(--warn)}.col-muted{color:var(--muted)}

  .sec{font-size:0.65rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--muted);
    margin:28px 0 14px;display:flex;align-items:center;gap:10px}
  .sec::after{content:'';flex:1;height:1px;background:var(--border)}

  /* ‚îÄ‚îÄ Market section header bar (separate from .sec) ‚îÄ‚îÄ */
  .mkt-header{display:flex;align-items:center;justify-content:space-between;
    margin:20px 0 12px;gap:12px;flex-wrap:wrap}
  .mkt-header-left{font-size:0.65rem;text-transform:uppercase;letter-spacing:0.1em;
    color:var(--muted);display:flex;align-items:center;gap:10px;flex:1}
  .mkt-header-left::after{content:'';flex:1;height:1px;background:var(--border)}
  .mkt-header-right{display:flex;align-items:center;gap:10px;flex-shrink:0}

  .panel{background:var(--surface);border:1px solid var(--border);border-radius:14px;
    margin-bottom:10px;overflow:hidden;transition:border-color 0.2s}
  .panel:hover{border-color:rgba(0,229,160,0.2)}
  .panel-hdr{display:grid;grid-template-columns:1fr auto 24px;align-items:center;
    padding:16px 20px;cursor:pointer;user-select:none;gap:24px}
  .panel-title{display:flex;align-items:center;gap:10px;font-weight:600;font-size:0.95rem}
  .panel-emoji{font-size:1.05rem}
  /* Fixed-width meta zone ‚Äî always 280px so all panels align identically */
  .panel-meta{display:flex;gap:28px;align-items:center;justify-content:flex-end;width:280px}
  .pm-item{text-align:right;min-width:60px}
  .pm-item .pm-l{font-size:0.58rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.05em;white-space:nowrap}
  .pm-item .pm-v{font-family:'DM Mono',monospace;font-size:0.82rem;font-weight:600;margin-top:2px;white-space:nowrap}
  /* Chevron always same size, centered in its column */
  .chevron{font-size:0.7rem;color:var(--muted);transition:transform 0.3s,color 0.2s;
    text-align:center;line-height:1}
  .panel-hdr:hover .chevron{color:var(--accent)}
  .panel-body{max-height:0;overflow:hidden;transition:max-height 0.45s cubic-bezier(0.4,0,0.2,1)}
  .panel-body.open{max-height:4000px}
  .panel-body-inner{padding:4px 20px 20px}

  .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(155px,1fr));gap:12px}
  .card{background:var(--surface2);border:1px solid var(--border);border-radius:14px;padding:18px 16px;
    animation:fadeUp 0.5s ease both;transition:border-color 0.2s,transform 0.15s}
  .card:hover{border-color:rgba(0,229,160,0.28);transform:translateY(-2px)}
  @keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
  .card:nth-child(1){animation-delay:.05s}.card:nth-child(2){animation-delay:.1s}
  .card:nth-child(3){animation-delay:.15s}.card:nth-child(4){animation-delay:.2s}
  .card .cl{font-size:0.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:8px}
  .card .cv{font-family:'DM Mono',monospace;font-size:1.2rem;font-weight:500}
  .card .cs{font-size:0.72rem;color:var(--muted);margin-top:4px}
  .g{color:var(--accent)}.r{color:var(--warn)}.b{color:var(--accent2)}.go{color:var(--gold)}

  .fund-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(290px,1fr));gap:14px}
  .fund-card{background:var(--surface2);border:1px solid var(--border);border-radius:16px;
    padding:22px;transition:border-color 0.2s,transform 0.15s;animation:fadeUp 0.5s ease both;position:relative;overflow:hidden}
  .fund-card:hover{transform:translateY(-3px)}
  .fc-head{display:flex;gap:14px;align-items:flex-start;margin-bottom:18px}
  .ficon{width:46px;height:46px;border-radius:12px;flex-shrink:0;display:flex;align-items:center;
    justify-content:center;font-family:'DM Mono',monospace;font-size:0.72rem;font-weight:700;color:#fff;letter-spacing:0.04em}
  .fc-title .fname{font-weight:600;font-size:0.9rem;line-height:1.4}
  .fc-title .fhouse{font-size:0.7rem;color:var(--muted);margin-top:2px}
  .nav-pill{display:inline-block;font-family:'DM Mono',monospace;font-size:0.68rem;
    padding:4px 10px;border-radius:999px;margin-top:7px}
  .nav-pill.ok{background:rgba(0,229,160,0.1);border:1px solid rgba(0,229,160,0.25);color:var(--accent)}
  .nav-pill.no{background:rgba(255,107,107,0.08);border:1px solid rgba(255,107,107,0.2);color:var(--warn)}
  .fc-stats{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
  .fc-stat .sl{font-size:0.6rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.06em}
  .fc-stat .sv{font-family:'DM Mono',monospace;font-size:0.93rem;margin-top:3px;font-weight:600}
  .fc-stat.full{grid-column:1/-1}
  .fc-bar{height:4px;border-radius:999px;background:var(--surface2);overflow:hidden;margin-top:12px}
  .fc-bar-fill{height:100%;border-radius:999px}
  .fc-pct{font-size:0.63rem;color:var(--muted);margin-top:5px;font-family:'DM Mono',monospace}

  .txn-wrap{overflow:hidden}
  .txn-wrap table{width:100%;border-collapse:collapse}
  .txn-wrap th{font-size:0.62rem;text-transform:uppercase;letter-spacing:0.07em;color:var(--muted);
    padding:11px 16px;text-align:left;border-bottom:1px solid var(--border);background:var(--bg);font-weight:500}
  .txn-wrap td{font-size:0.8rem;padding:11px 16px;border-bottom:1px solid rgba(37,41,51,0.5);font-family:'DM Mono',monospace}
  .txn-wrap tr:last-child td{border-bottom:none}
  .txn-wrap tr:hover td{background:rgba(255,255,255,0.013)}
  .fund-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px;flex-shrink:0}
  .txn-name{font-family:'DM Sans',sans-serif;font-size:0.8rem;font-weight:500}
  .txn-sub{font-size:0.68rem;color:var(--muted);margin-top:2px}
  .txn-more{text-align:center;padding:12px;font-size:0.75rem;color:var(--accent2);
    cursor:pointer;font-family:'DM Mono',monospace;border-top:1px solid var(--border)}
  .txn-more:hover{background:rgba(61,139,255,0.05)}

  /* ‚îÄ‚îÄ Projection ‚îÄ‚îÄ */
  .slider-row{display:flex;align-items:center;gap:14px;margin-bottom:16px;flex-wrap:wrap}
  .slider-row label{font-size:0.78rem;color:var(--muted);min-width:170px}
  input[type=range]{-webkit-appearance:none;width:160px;height:4px;border-radius:2px;background:var(--border);outline:none;cursor:pointer}
  input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;
    border-radius:50%;background:var(--accent);cursor:pointer;box-shadow:0 0 8px rgba(0,229,160,0.45)}
  #rate-val{font-family:'DM Mono',monospace;color:var(--accent);font-size:0.95rem;min-width:38px}

  /* ‚îÄ‚îÄ NEW: Editable SIP / Target inputs ‚îÄ‚îÄ */
  .proj-inputs{display:flex;gap:14px;flex-wrap:wrap;margin-bottom:20px;
    background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 16px}
  .proj-input-group{display:flex;flex-direction:column;gap:5px;flex:1;min-width:140px}
  .proj-input-group label{font-size:0.62rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.07em}
  .proj-input-group input[type=number]{background:var(--bg);border:1px solid var(--border);
    color:var(--text);font-family:'DM Mono',monospace;font-size:0.95rem;font-weight:600;
    padding:8px 10px;border-radius:7px;outline:none;width:100%;transition:border-color 0.2s}
  .proj-input-group input[type=number]:focus{border-color:var(--accent)}
  .proj-input-group input[type=number]::-webkit-inner-spin-button{opacity:0.4}
  .proj-input-note{font-size:0.6rem;color:var(--muted)}

  .proj-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:20px}
  .pi{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center}
  .pi.hi{background:linear-gradient(135deg,rgba(0,229,160,0.12),rgba(61,139,255,0.12));border-color:rgba(0,229,160,0.28)}
  .pi .pl{font-size:0.63rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:6px}
  .pi .pv{font-family:'DM Mono',monospace;font-size:1rem;font-weight:600}
  .pi.hi .pv{color:var(--accent);font-size:1.2rem}
  .prog-track{background:var(--surface2);border-radius:999px;height:10px;overflow:hidden}
  .prog-fill{height:100%;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width 0.6s ease}
  .prog-labels{display:flex;justify-content:space-between;font-size:0.68rem;color:var(--muted);margin-bottom:6px}
  .prog-pct{text-align:center;font-family:'DM Mono',monospace;font-size:0.73rem;color:var(--accent2);margin-top:6px}

  .market-status{font-size:0.68rem;color:var(--muted);font-family:'DM Mono',monospace}
  .market-status .live{color:var(--accent)}
  .market-status .closed{color:var(--gold)}

  .err-box{background:rgba(255,107,107,0.07);border:1px solid rgba(255,107,107,0.25);border-radius:12px;
    padding:20px 24px;color:var(--warn);font-family:'DM Mono',monospace;font-size:0.82rem;text-align:center;margin:40px 0}

  .refresh-btn{display:inline-flex;align-items:center;gap:6px;background:rgba(61,139,255,0.1);
    border:1px solid rgba(61,139,255,0.25);color:var(--accent2);font-family:'DM Mono',monospace;
    font-size:0.72rem;padding:6px 14px;border-radius:999px;cursor:pointer;transition:all 0.2s;margin-left:12px}
  .refresh-btn:hover{background:rgba(61,139,255,0.18)}
  .refresh-btn.spinning svg{animation:spin 1s linear infinite}

  @media(max-width:600px){
    .hdr h1{font-size:1.5rem}
    .fund-grid{grid-template-columns:1fr}
    .txn-wrap{overflow-x:auto}
    .market-grid{grid-template-columns:repeat(2,1fr)}
    .panel-meta{display:none}
  }
</style>
</head>
<body>

<div id="loader"><div class="spinner"></div><p>Loading portfolio‚Ä¶</p></div>

<div class="tape-wrap"><div class="tape-track" id="tape-track"></div></div>

<div class="wrap">

  <div class="mkt-header">
    <div class="mkt-header-left">Live Market Prices</div>
    <div class="mkt-header-right">
      <span id="mkt-status" class="market-status"></span>
      <button class="refresh-btn" id="refresh-btn" onclick="fetchMarket()" title="Refresh">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
        Refresh
      </button>
    </div>
  </div>

  <div class="market-grid" id="market-grid">
    <div class="mcard mcard-skeleton" id="mc-0"><div class="mc-label">NIFTY 50</div><div class="mc-price">‚Äî</div><div class="mc-chg flat">‚Äî</div></div>
    <div class="mcard mcard-skeleton" id="mc-1"><div class="mc-label">BANK NIFTY</div><div class="mc-price">‚Äî</div><div class="mc-chg flat">‚Äî</div></div>
    <div class="mcard mcard-skeleton" id="mc-2"><div class="mc-label">NIFTY IT</div><div class="mc-price">‚Äî</div><div class="mc-chg flat">‚Äî</div></div>
    <div class="mcard mcard-skeleton" id="mc-3"><div class="mc-label">NIFTY MIDCAP 100</div><div class="mc-price">‚Äî</div><div class="mc-chg flat">‚Äî</div></div>
    <div class="mcard mcard-skeleton" id="mc-4"><div class="mc-label">NIFTY 500</div><div class="mc-price">‚Äî</div><div class="mc-chg flat">‚Äî</div></div>
    <div class="mcard mcard-skeleton" id="mc-5"><div class="mc-label">NASDAQ 100</div><div class="mc-price">‚Äî</div><div class="mc-chg flat">‚Äî</div></div>
    <div class="mcard mcard-skeleton" id="mc-6"><div class="mc-label">GOLD (USD)</div><div class="mc-price">‚Äî</div><div class="mc-chg flat">‚Äî</div></div>
    <div class="mcard mcard-skeleton" id="mc-7"><div class="mc-label">SILVER (USD)</div><div class="mc-price">‚Äî</div><div class="mc-chg flat">‚Äî</div></div>
  </div>

  <div class="hdr">
    <div class="hdr-top">
      <div>
        <h1>My Portfolio<br><span>NAV Dashboard</span></h1>
        <div class="hdr-meta">Updated daily via <b>GitHub Actions</b> ¬∑ NAV from AMFI</div>
      </div>
      <div class="badge-auto"><div class="dot"></div><span id="update-time">Auto-updated</span></div>
    </div>
    <div class="goal-bar">
      <div class="gi"><div class="gl">Total Invested</div><div class="gv col-blue"  id="hdr-inv">‚Äî</div></div>
      <div class="gi"><div class="gl">Portfolio Value</div><div class="gv col-green" id="hdr-val">‚Äî</div></div>
      <div class="gi"><div class="gl">Total Gain / Loss</div><div class="gv" id="hdr-gain">‚Äî</div></div>
      <div class="gi"><div class="gl">XIRR (approx)</div><div class="gv col-gold"  id="hdr-xirr">‚Äî</div></div>
      <div class="gi"><div class="gl">NAV as of</div><div class="gv col-muted"     id="hdr-navdate">‚Äî</div></div>
    </div>
  </div>

  <div class="panel">
    <div class="panel-hdr" onclick="togglePanel(this)" aria-expanded="true">
      <div class="panel-title"><span class="panel-emoji">üìä</span> Overview</div>
      <div class="panel-meta">
        <div class="pm-item"><div class="pm-l">Funds</div><div class="pm-v col-blue" id="pm-funds">‚Äî</div></div>
        <div class="pm-item"><div class="pm-l">Transactions</div><div class="pm-v go" id="pm-txns">‚Äî</div></div>
      </div>
      <div class="chevron">‚à®</div>
    </div>
    <div class="panel-body open">
      <div class="panel-body-inner">
        <div class="cards">
          <div class="card"><div class="cl">Total Invested</div><div class="cv b" id="kpi-inv">‚Äî</div><div class="cs" id="kpi-funds">‚Äî</div></div>
          <div class="card"><div class="cl">Live Value</div><div class="cv g" id="kpi-val">‚Äî</div><div class="cs">Latest NAV</div></div>
          <div class="card"><div class="cl">Gain / Loss</div><div class="cv" id="kpi-gain">‚Äî</div><div class="cs" id="kpi-pct">‚Äî</div></div>
          <div class="card"><div class="cl">Transactions</div><div class="cv go" id="kpi-count">‚Äî</div><div class="cs" id="kpi-funds2">‚Äî unique funds</div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="panel-hdr" onclick="togglePanel(this)" aria-expanded="true">
      <div class="panel-title"><span class="panel-emoji">üè¶</span> Holdings ‚Äî Bird's Eye View</div>
      <div class="panel-meta" id="pm-holdings"></div>
      <div class="chevron">‚à®</div>
    </div>
    <div class="panel-body open">
      <div class="panel-body-inner">
        <div class="fund-grid" id="fund-grid"></div>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="panel-hdr" onclick="togglePanel(this)" aria-expanded="false">
      <div class="panel-title"><span class="panel-emoji">üìã</span> Transaction History</div>
      <div class="panel-meta">
        <div class="pm-item"><div class="pm-l">Total</div><div class="pm-v" id="pm-txn-count">‚Äî</div></div>
      </div>
      <div class="chevron" id="chevron-txn" style="transform:rotate(180deg)">‚à®</div>
    </div>
    <div class="panel-body">
      <div class="panel-body-inner">
        <div class="txn-wrap" id="txn-table"></div>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="panel-hdr" onclick="togglePanel(this)" aria-expanded="true">
      <div class="panel-title"><span class="panel-emoji">üéØ</span> Wealth Projection</div>
      <div class="panel-meta">
        <div class="pm-item"><div class="pm-l">Target</div><div class="pm-v col-gold" id="pm-target">‚Äî</div></div>
        <div class="pm-item"><div class="pm-l">Progress</div><div class="pm-v col-green" id="pm-progress">‚Äî</div></div>
      </div>
      <div class="chevron">‚à®</div>
    </div>
    <div class="panel-body open">
      <div class="panel-body-inner">

        <!-- ‚îÄ‚îÄ NEW: Editable SIP & Target ‚îÄ‚îÄ -->
        <div class="proj-inputs">
          <div class="proj-input-group">
            <label>Monthly SIP (‚Çπ)</label>
            <input type="number" id="input-sip" value="10000" min="500" step="500" oninput="calcProj()">
            <div class="proj-input-note">Your monthly SIP amount</div>
          </div>
          <div class="proj-input-group">
            <label>Target Corpus (‚Çπ)</label>
            <input type="number" id="input-goal" value="2000000" min="100000" step="100000" oninput="calcProj()">
            <div class="proj-input-note">Your wealth goal</div>
          </div>
        </div>

        <div class="slider-row">
          <label>Expected Annual Return:</label>
          <input type="range" id="rate" min="6" max="18" value="10" step="0.5" oninput="calcProj()">
          <span id="rate-val">10%</span>
        </div>
        <div class="proj-grid">
          <div class="pi"><div class="pl">Current Value</div><div class="pv" id="p-corpus">‚Äî</div></div>
          <div class="pi"><div class="pl">Monthly SIP</div><div class="pv" id="p-sip">‚Äî</div></div>
          <div class="pi"><div class="pl">Growth Earned</div><div class="pv" id="p-growth">‚Äî</div></div>
          <div class="pi hi"><div class="pl">üéØ Future Value</div><div class="pv" id="p-total">‚Äî</div></div>
        </div>
        <div class="prog-labels"><span id="prog-l">Now: ‚Äî</span><span id="prog-r">Target: ‚Äî</span></div>
        <div class="prog-track"><div class="prog-fill" id="prog" style="width:0%"></div></div>
        <div class="prog-pct" id="prog-pct">‚Äî</div>
      </div>
    </div>
  </div>

</div>

<script>
const DATA_URL    = './data/portfolio.json';
const TARGET_DATE = new Date(2027, 11, 6);

const MARKET_SYMBOLS = [
  { symbol: '^NSEI',               label: 'NIFTY 50',         currency: '‚Çπ', decimals: 2 },
  { symbol: '^NSEBANK',            label: 'BANK NIFTY',       currency: '‚Çπ', decimals: 2 },
  { symbol: '^CNXIT',              label: 'NIFTY IT',         currency: '‚Çπ', decimals: 2 },
  { symbol: 'NIFTY_MIDCAP_100.NS', label: 'NIFTY MIDCAP 100', currency: '‚Çπ', decimals: 2 },
  { symbol: '^CRSLDX',             label: 'NIFTY 500',        currency: '‚Çπ', decimals: 2 },
  { symbol: 'NQ=F',                label: 'NASDAQ 100',       currency: '$', decimals: 2 },
  { symbol: 'GC=F',                label: 'GOLD (USD)',     currency: '$', decimals: 2 },
  { symbol: 'XAG39343-USD',                label: 'SILVER (USD)',   currency: '$', decimals: 3 },
];

// ‚îÄ‚îÄ Proxies: plain data relays (not anonymizers ‚Äî Seqrite won't block) ‚îÄ‚îÄ
const PROXIES = [
  url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
  url => `https://thingproxy.freeboard.io/fetch/${url}`,
];
const YAHOO_BASE = 'https://query1.finance.yahoo.com/v8/finance/chart/';

// Remembers which proxy worked last ‚Äî uses it first next time
let _bestProxy = 0;

let marketData = {};

function togglePanel(hdr) {
  const body    = hdr.nextElementSibling;
  const chevron = hdr.querySelector('.chevron');
  const isOpen  = body.classList.contains('open');
  body.classList.toggle('open', !isOpen);
  // open = pointing down (0¬∞), closed = pointing up (180¬∞)
  chevron.style.transform = isOpen ? 'rotate(180deg)' : 'rotate(0deg)';
  hdr.setAttribute('aria-expanded', String(!isOpen));
}

async function fetchOneTicker(sym) {
  const rawUrl = YAHOO_BASE + encodeURIComponent(sym) + '?interval=1d&range=2d';
  // Try last known-good proxy first, then fallback
  const order = [_bestProxy, ...[...Array(PROXIES.length).keys()].filter(i => i !== _bestProxy)];
  for (const idx of order) {
    try {
      const res = await fetch(PROXIES[idx](rawUrl), { signal: AbortSignal.timeout(9000) });
      if (!res.ok) continue;
      const json = await res.json();
      const meta = json?.chart?.result?.[0]?.meta;
      if (!meta || !meta.regularMarketPrice) continue;
      _bestProxy = idx; // remember what worked
      const price     = meta.regularMarketPrice;
      const prevClose = meta.chartPreviousClose ?? meta.previousClose ?? null;
      const change    = prevClose ? price - prevClose : null;
      const changePct = prevClose ? ((price - prevClose) / prevClose) * 100 : null;
      const stateMap  = { REGULAR:'Live', PRE:'Pre-Market', POST:'After Hours', POSTPOST:'After Hours', CLOSED:'Closed', UNKNOWN:'Closed' };
      const rawState  = meta.marketState ?? 'UNKNOWN';
      return { price, prevClose, change, changePct, state: stateMap[rawState]||'Closed', rawState };
    } catch(e) { continue; }
  }
  return null;
}

async function fetchMarket() {
  const btn = document.getElementById('refresh-btn');
  btn.classList.add('spinning');
  // Pass index so each symbol uses a different proxy first
  const results = await Promise.all(MARKET_SYMBOLS.map(s => fetchOneTicker(s.symbol)));
  results.forEach((data, i) => {
    const cfg  = MARKET_SYMBOLS[i];
    const card = document.getElementById('mc-' + i);
    if (!card) return;
    card.classList.remove('mcard-skeleton');
    if (!data || data.price === null) {
      card.innerHTML = `<div class="mc-label">${cfg.label}</div><div class="mc-price" style="color:var(--muted)">‚Äî</div><div class="mc-chg flat">unavailable</div>`;
      return;
    }
    const up   = data.changePct >= 0;
    const cls  = Math.abs(data.changePct) < 0.01 ? 'flat' : (up ? 'up' : 'dn');
    const sign = up ? '+' : '';
    const fmt  = v => v.toLocaleString('en-IN', {minimumFractionDigits: cfg.decimals, maximumFractionDigits: cfg.decimals});
    marketData[cfg.symbol] = data;
    card.innerHTML = `
      <div class="mc-label">${cfg.label}</div>
      <div class="mc-price">${cfg.currency}${fmt(data.price)}</div>
      <div class="mc-chg ${cls}">${sign}${data.change.toFixed(2)} (${sign}${data.changePct.toFixed(2)}%)</div>
      <div class="mc-sub">${data.rawState === 'REGULAR' ? '<span class="pulse-dot"></span>Live' : data.state}</div>`;
  });
  updateTape(results);
  updateMarketStatus(results);
  btn.classList.remove('spinning');
}

function updateTape(results) {
  const track = document.getElementById('tape-track');
  const items = MARKET_SYMBOLS.map((cfg, i) => {
    const d = results[i];
    if (!d || d.price === null) return `<div class="tape-item"><span class="ti-name">${cfg.label}</span><span class="ti-price" style="color:var(--muted)">‚Äî</span></div>`;
    const up  = d.changePct >= 0;
    const cls = Math.abs(d.changePct) < 0.01 ? 'flat' : (up ? 'up' : 'dn');
    const sign = up ? '+' : '';
    const fmt  = v => v.toLocaleString('en-IN', {minimumFractionDigits: cfg.decimals, maximumFractionDigits: cfg.decimals});
    return `<div class="tape-item"><span class="ti-name">${cfg.label}</span><span class="ti-price">${cfg.currency}${fmt(d.price)}</span><span class="ti-chg ${cls}">${sign}${d.changePct.toFixed(2)}%</span></div>`;
  }).join('');
  track.innerHTML = items + items;
}

function updateMarketStatus(results) {
  const statuses = results.filter(Boolean).map(r => r.rawState);
  const isLive   = statuses.some(s => s === 'REGULAR' || s === 'PRE');
  const el = document.getElementById('mkt-status');
  const t  = new Date().toLocaleTimeString('en-IN', {hour:'2-digit', minute:'2-digit', timeZone:'Asia/Kolkata'}) + ' IST';
  el.innerHTML = isLive
    ? `<span class="live"><span class="pulse-dot"></span>Market Open</span> ¬∑ ${t}`
    : `<span class="closed">Market Closed</span> ¬∑ ${t}`;
}

const inr  = v => '‚Çπ' + Math.round(v).toLocaleString('en-IN');
const inrL = v => v >= 1e5 ? '‚Çπ' + (v/1e5).toFixed(2)+'L' : inr(v);
const mo   = (a,b) => (b.getFullYear()-a.getFullYear())*12+(b.getMonth()-a.getMonth());

window.addEventListener('DOMContentLoaded', async () => {
  fetchMarket();
  setInterval(fetchMarket, 60_000);
  try {
    const res = await fetch(DATA_URL + '?t=' + Date.now());
    if (!res.ok) throw new Error(`HTTP ${res.status} ‚Äî portfolio.json not found`);
    const data = await res.json();
    render(data);
  } catch (err) {
    document.getElementById('loader').classList.add('hide');
    document.querySelector('.wrap').insertAdjacentHTML('afterbegin',
      `<div class="err-box">‚ö† Could not load portfolio data.<br><br>Make sure <code>data/portfolio.json</code> exists in your repo.<br><br><small>${err.message}</small></div>`);
  }
});

let _liveCorpus = 0;

function render(data) {
  const s = data.summary, funds = data.holdings||[], txns = data.transactions||[];
  const d = new Date(data.generatedAt);
  document.getElementById('update-time').textContent =
    'Updated ' + d.toLocaleDateString('en-IN',{day:'numeric',month:'short'}) + ' ¬∑ ' + d.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});
  document.getElementById('hdr-inv').textContent  = inr(s.totalInvested);
  document.getElementById('hdr-val').textContent  = inr(s.totalValue);
  const g = s.totalGain;
  document.getElementById('hdr-gain').textContent = (g>=0?'+':'‚àí') + inr(Math.abs(g));
  document.getElementById('hdr-gain').className   = 'gv ' + (g>=0?'col-green':'col-red');
  document.getElementById('hdr-xirr').textContent = s.xirr ? s.xirr + '% p.a.' : '‚Äî';
  document.getElementById('hdr-navdate').textContent = funds.find(f=>f.navDate)?.navDate || '‚Äî';
  document.getElementById('pm-funds').textContent = s.fundCount;
  document.getElementById('pm-txns').textContent  = s.txnCount;
  document.getElementById('kpi-inv').textContent   = inr(s.totalInvested);
  document.getElementById('kpi-funds').textContent  = s.fundCount + ' fund' + (s.fundCount!==1?'s':'');
  document.getElementById('kpi-val').textContent    = inr(s.totalValue);
  document.getElementById('kpi-gain').textContent   = (g>=0?'+':'‚àí') + inr(Math.abs(g));
  document.getElementById('kpi-gain').className     = 'cv ' + (g>=0?'g':'r');
  document.getElementById('kpi-pct').textContent    = (s.gainPct>=0?'+':'') + s.gainPct + '%';
  document.getElementById('kpi-pct').className      = 'cs ' + (s.gainPct>=0?'g':'r');
  document.getElementById('kpi-count').textContent  = s.txnCount;
  document.getElementById('kpi-funds2').textContent = s.fundCount + ' unique funds';
  document.getElementById('pm-txn-count').textContent = s.txnCount + ' txns';
  renderFundGrid(funds);
  renderTxnTable(txns);
  _liveCorpus = s.totalValue;
  calcProj();
  document.getElementById('loader').classList.add('hide');
}

function renderFundGrid(funds) {
  const grid = document.getElementById('fund-grid');
  grid.innerHTML = '';
  if (funds.length) {
    const sorted = [...funds].sort((a,b)=>b.gainPct-a.gainPct);
    const best=sorted[0], worst=sorted[sorted.length-1];
    document.getElementById('pm-holdings').innerHTML =
      `<div class="pm-item"><div class="pm-l">Best</div><div class="pm-v g">${best.short||'‚Äî'} +${best.gainPct}%</div></div>
       <div class="pm-item"><div class="pm-l">Worst</div><div class="pm-v r">${worst.short||'‚Äî'} ${worst.gainPct>=0?'+':''}${worst.gainPct}%</div></div>`;
  }
  funds.forEach((f,i)=>{
    const color=f.color||'#6b7385', gainCls=f.gain>=0?'g':'r';
    const navStr=f.liveNAV
      ?`<span class="nav-pill ok">NAV ‚Çπ${f.liveNAV.toFixed(4)} ¬∑ ${f.navDate||''}</span>`
      :`<span class="nav-pill no">NAV unavailable</span>`;
    const card=document.createElement('div');
    card.className='fund-card';
    card.style.cssText=`animation-delay:${i*0.1}s;border-color:${color}33`;
    card.innerHTML=`
      <div class="fc-head">
        <div class="ficon" style="background:linear-gradient(135deg,${color}cc,${color})">${f.short||'MF'}</div>
        <div class="fc-title"><div class="fname">${f.fundName}</div><div class="fhouse">${f.fundHouse}</div>${navStr}</div>
      </div>
      <div class="fc-stats">
        <div class="fc-stat"><div class="sl">Invested</div><div class="sv b">${inr(f.invested)}</div></div>
        <div class="fc-stat"><div class="sl">Live Value</div><div class="sv g">${inr(f.liveValue)}</div></div>
        <div class="fc-stat"><div class="sl">Units</div><div class="sv">${f.units.toFixed(4)}</div></div>
        <div class="fc-stat"><div class="sl">Avg NAV</div><div class="sv">‚Çπ${f.avgNAV.toFixed(4)}</div></div>
        <div class="fc-stat full"><div class="sl">Gain / Loss</div>
          <div class="sv ${gainCls}">${f.gain>=0?'+':'‚àí'}${inr(Math.abs(f.gain))} &nbsp;(${f.gainPct}%)</div></div>
      </div>
      <div class="fc-bar"><div class="fc-bar-fill" style="width:${f.portfolioPct}%;background:${color}"></div></div>
      <div class="fc-pct">${f.portfolioPct}% of portfolio ¬∑ ${allTransactionsForFund(f.fundName)} transactions</div>`;
    grid.appendChild(card);
  });
}

let _txns=[];
function allTransactionsForFund(name){return _txns.filter(t=>t.fundName===name).length}

function renderTxnTable(txns){
  _txns=txns;
  const wrap=document.getElementById('txn-table'),PAGE=15;
  let showing=PAGE;
  function buildTable(){
    const rows=txns.slice(0,showing).map(t=>{
      const color=getFundColor(t.fundName);
      return `<tr>
        <td><span class="fund-dot" style="background:${color}"></span><span class="txn-name">${t.fundName.length>44?t.fundName.slice(0,44)+'‚Ä¶':t.fundName}</span><div class="txn-sub">Folio ${t.folio}</div></td>
        <td style="color:var(--muted)">${t.date}</td>
        <td class="b">${inr(t.invested)}</td>
        <td>${t.units.toFixed(4)}</td>
        <td>‚Çπ${t.historicalNAV.toFixed(4)}</td>
        <td>${inr(t.historicalValue)}</td></tr>`;
    }).join('');
    const more=showing<txns.length?`<tr><td colspan="6" class="txn-more" id="show-more">‚Üì Show more (${txns.length-showing} remaining)</td></tr>`:'';
    wrap.innerHTML=`<table><thead><tr><th>Fund</th><th>Date</th><th>Invested</th><th>Units</th><th>NAV at Buy</th><th>Value at Buy</th></tr></thead><tbody>${rows}${more}</tbody></table>`;
    const btn=document.getElementById('show-more');
    if(btn) btn.addEventListener('click',()=>{showing=Math.min(showing+PAGE,txns.length);buildTable();});
  }
  buildTable();
}

function getFundColor(name){
  const n=name.toLowerCase();
  if(n.includes('kotak')) return '#3d8bff';
  if(n.includes('multi')) return '#fbbf24';
  if(n.includes('equity')||n.includes('saving')) return '#34d399';
  return '#6b7385';
}

function calcProj(){
  const rate = parseFloat(document.getElementById('rate').value);
  // ‚îÄ‚îÄ NEW: read live SIP and Goal from inputs ‚îÄ‚îÄ
  const SIP  = parseFloat(document.getElementById('input-sip').value)  || 10000;
  const GOAL = parseFloat(document.getElementById('input-goal').value) || 2000000;
  document.getElementById('rate-val').textContent = rate + '%';
  const r=rate/100/12, months=mo(new Date(),TARGET_DATE), c=_liveCorpus||0;
  const fvC=c*Math.pow(1+r,months);
  const fvS=SIP*((Math.pow(1+r,months)-1)/r)*(1+r);
  const tot=fvC+fvS, grow=tot-c-SIP*months;
  const pct=Math.min((tot/GOAL)*100,100);
  document.getElementById('p-corpus').textContent = inrL(c);
  document.getElementById('p-sip').textContent    = inrL(SIP)+'/mo';
  document.getElementById('p-growth').textContent = inrL(grow);
  document.getElementById('p-total').textContent  = inrL(tot);
  document.getElementById('prog-l').textContent   = 'Now: '+inrL(c);
  document.getElementById('prog-r').textContent   = 'Target: '+inrL(GOAL);
  document.getElementById('prog').style.width     = pct+'%';
  document.getElementById('prog-pct').textContent = pct.toFixed(1)+'% of '+inrL(GOAL);
  document.getElementById('pm-target').textContent   = inrL(GOAL);
  document.getElementById('pm-progress').textContent = pct.toFixed(1)+'%';
}
</script>
</body>
</html>
